# Copyright 2024 Canonical Ltd.
# See LICENSE file for licensing details.

name: jenkins-agent-k8s
summary: Jenkins-agent-k8s rock
description: Jenkins-agent-k8s OCI image for the Jenkins-agent-k8s charm
version: "1.1"
base: ubuntu:22.04
build-base: ubuntu:22.04
license: Apache-2.0
platforms:
  amd64:
run-user: _daemon_
parts:
  jenkins:
    plugin: nil
    overlay-packages:
      - bash
      - ca-certificates-java
      - default-jre-headless
      - git
    override-prime: |
      craftctl default
      /bin/bash -c "mkdir -p --mode=775 usr/share/{jenkins,jenkins/agents} var/log/jenkins"
  jenkins-agent-script:
    plugin: dump
    source: https://github.com/jenkinsci/docker-inbound-agent.git
    organize:
      jenkins-agent: /var/lib/jenkins/jenkins-agent
  entrypoint:
    plugin: dump
    source: files
    organize:
      entrypoint.sh: /var/lib/jenkins/entrypoint.sh
    override-prime: |
      craftctl default
      /bin/bash -c "chmod +x var/lib/jenkins/entrypoint.sh"
  jenkins-agent-configure:
    plugin: nil
    after:
      - "jenkins"
      - "jenkins-agent-script"
      - "entrypoint"
    override-prime: |
      craftctl default
      /bin/bash -c "chown -R 584792:584792 $CRAFT_PRIME/var/log/jenkins $CRAFT_PRIME/usr/share/jenkins"
